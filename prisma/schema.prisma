// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SystemRole {
  ROOT
  ADMIN
  PROJECT_USER
}

enum Status {
  ACTIVE
  INACTIVE
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  PAUSED
  COMPLETED
}

// Status do funil de Lead
enum LeadStatus {
  PRIMEIRO_CONTATO
  REUNIAO
  PROPOSTA_ENVIADA
  ANALISE_PROPOSTA
  FECHADO_GANHO
  FECHADO_PERDIDO
}

enum TokenType {
  PASSWORD_RESET
  ACCOUNT_ACTIVATION
}

model User {
  id                String          @id @default(uuid())
  email             String          @unique
  phone             String?
  name              String
  password          String?
  role              SystemRole // O papel DESTE usuário no sistema
  status            Status          @default(ACTIVE)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  adminOfProjects   Project[]       @relation("AdminOfProjects")
  memberOfProjects  ProjectMember[]
  assignedLeads     Lead[]          @relation("AssignedUserLeads")
  leadStatusChanges LeadHistory[]   @relation("LeadStatusChangesByUser")
  tokens            Token[]

  @@index([status, role])
}

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  adminId     String
  admin       User          @relation("AdminOfProjects", fields: [adminId], references: [id])

  members   ProjectMember[]
  leads     Lead[]
  campaigns Campaign[]

  @@index([adminId])
  @@index([status])
}

model ProjectMember {
  id        String   @id @default(uuid())
  userId    String
  projectId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, projectId])
}

model Lead {
  id             String        @id @default(uuid())
  name           String
  email          String? // contato opcional
  phone          String? // contato opcional
  position       String? // cargo do lead
  requestType    String? // tipo de serviço solicitado (solicitacao)
  status         LeadStatus    @default(PRIMEIRO_CONTATO)
  projectId      String
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedUserId String?
  assignedUser   User?         @relation("AssignedUserLeads", fields: [assignedUserId], references: [id])
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime? // soft delete
  history        LeadHistory[]

  @@index([status, projectId])
  @@index([email])
  @@index([phone])
  @@index([assignedUserId])
}

model LeadHistory {
  id              String      @id @default(uuid())
  leadId          String
  lead            Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  fromStatus      LeadStatus?
  toStatus        LeadStatus
  changedByUserId String?
  changedBy       User?       @relation("LeadStatusChangesByUser", fields: [changedByUserId], references: [id])
  reason          String? // motivo da mudança (perda/ganho etc)
  createdAt       DateTime    @default(now())

  @@index([leadId])
  @@index([toStatus])
}

model Campaign {
  id                  String   @id @default(uuid())
  projectId           String
  project             Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name                String
  // Representação de período: mês/ano de pagamento e da campanha
  monthPayment        Int // 1..12
  yearPayment         Int
  monthCampaign       Int // 1..12
  yearCampaign        Int
  // Métricas base (valores de entrada)
  clicks              Int      @default(0)
  conversions         Int      @default(0)
  qualified           Int      @default(0)
  sales               Int      @default(0)
  investmentGoogleAds Decimal  @default(0)
  investmentTotal     Decimal  @default(0)
  approvalsRate       Float?
  goalQualifiedConv   Float?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([projectId])
  @@index([yearCampaign, monthCampaign])
}

model Token {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  type      TokenType
  expiresAt DateTime
  used      Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@index([token, type])
  @@index([userId])
  @@index([expiresAt])
}
